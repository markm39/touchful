var X=Object.defineProperty;var B=i=>{throw TypeError(i)};var G=(i,t,e)=>t in i?X(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var c=(i,t,e)=>G(i,typeof t!="symbol"?t+"":t,e),W=(i,t,e)=>t.has(i)||B("Cannot "+e);var n=(i,t,e)=>(W(i,t,"read from private field"),e?e.call(i):t.get(i)),m=(i,t,e)=>t.has(i)?B("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e),U=(i,t,e,a)=>(W(i,t,"write to private field"),a?a.call(i,e):t.set(i,e),e);import{g as Y}from"./index-B2600joV.js";var r;(function(i){i.LOAD="LOAD",i.EXEC="EXEC",i.FFPROBE="FFPROBE",i.WRITE_FILE="WRITE_FILE",i.READ_FILE="READ_FILE",i.DELETE_FILE="DELETE_FILE",i.RENAME="RENAME",i.CREATE_DIR="CREATE_DIR",i.LIST_DIR="LIST_DIR",i.DELETE_DIR="DELETE_DIR",i.ERROR="ERROR",i.DOWNLOAD="DOWNLOAD",i.PROGRESS="PROGRESS",i.LOG="LOG",i.MOUNT="MOUNT",i.UNMOUNT="UNMOUNT"})(r||(r={}));const K=(()=>{let i=0;return()=>i++})(),Z=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),V=new Error("called FFmpeg.terminate()");var d,p,u,O,L,S,h;class q{constructor(){m(this,d,null);m(this,p,{});m(this,u,{});m(this,O,[]);m(this,L,[]);c(this,"loaded",!1);m(this,S,()=>{n(this,d)&&(n(this,d).onmessage=({data:{id:t,type:e,data:a}})=>{switch(e){case r.LOAD:this.loaded=!0,n(this,p)[t](a);break;case r.MOUNT:case r.UNMOUNT:case r.EXEC:case r.FFPROBE:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:n(this,p)[t](a);break;case r.LOG:n(this,O).forEach(o=>o(a));break;case r.PROGRESS:n(this,L).forEach(o=>o(a));break;case r.ERROR:n(this,u)[t](a);break}delete n(this,p)[t],delete n(this,u)[t]})});m(this,h,({type:t,data:e},a=[],o)=>n(this,d)?new Promise((s,f)=>{const l=K();n(this,d)&&n(this,d).postMessage({id:l,type:t,data:e},a),n(this,p)[l]=s,n(this,u)[l]=f,o==null||o.addEventListener("abort",()=>{f(new DOMException(`Message # ${l} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(Z));c(this,"load",({classWorkerURL:t,...e}={},{signal:a}={})=>(n(this,d)||(U(this,d,t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"})),n(this,S).call(this)),n(this,h).call(this,{type:r.LOAD,data:e},void 0,a)));c(this,"exec",(t,e=-1,{signal:a}={})=>n(this,h).call(this,{type:r.EXEC,data:{args:t,timeout:e}},void 0,a));c(this,"ffprobe",(t,e=-1,{signal:a}={})=>n(this,h).call(this,{type:r.FFPROBE,data:{args:t,timeout:e}},void 0,a));c(this,"terminate",()=>{const t=Object.keys(n(this,u));for(const e of t)n(this,u)[e](V),delete n(this,u)[e],delete n(this,p)[e];n(this,d)&&(n(this,d).terminate(),U(this,d,null),this.loaded=!1)});c(this,"writeFile",(t,e,{signal:a}={})=>{const o=[];return e instanceof Uint8Array&&o.push(e.buffer),n(this,h).call(this,{type:r.WRITE_FILE,data:{path:t,data:e}},o,a)});c(this,"mount",(t,e,a)=>{const o=[];return n(this,h).call(this,{type:r.MOUNT,data:{fsType:t,options:e,mountPoint:a}},o)});c(this,"unmount",t=>{const e=[];return n(this,h).call(this,{type:r.UNMOUNT,data:{mountPoint:t}},e)});c(this,"readFile",(t,e="binary",{signal:a}={})=>n(this,h).call(this,{type:r.READ_FILE,data:{path:t,encoding:e}},void 0,a));c(this,"deleteFile",(t,{signal:e}={})=>n(this,h).call(this,{type:r.DELETE_FILE,data:{path:t}},void 0,e));c(this,"rename",(t,e,{signal:a}={})=>n(this,h).call(this,{type:r.RENAME,data:{oldPath:t,newPath:e}},void 0,a));c(this,"createDir",(t,{signal:e}={})=>n(this,h).call(this,{type:r.CREATE_DIR,data:{path:t}},void 0,e));c(this,"listDir",(t,{signal:e}={})=>n(this,h).call(this,{type:r.LIST_DIR,data:{path:t}},void 0,e));c(this,"deleteDir",(t,{signal:e}={})=>n(this,h).call(this,{type:r.DELETE_DIR,data:{path:t}},void 0,e))}on(t,e){t==="log"?n(this,O).push(e):t==="progress"&&n(this,L).push(e)}off(t,e){t==="log"?U(this,O,n(this,O).filter(a=>a!==e)):t==="progress"&&U(this,L,n(this,L).filter(a=>a!==e))}}d=new WeakMap,p=new WeakMap,u=new WeakMap,O=new WeakMap,L=new WeakMap,S=new WeakMap,h=new WeakMap;var v;(function(i){i.MEMFS="MEMFS",i.NODEFS="NODEFS",i.NODERAWFS="NODERAWFS",i.IDBFS="IDBFS",i.WORKERFS="WORKERFS",i.PROXYFS="PROXYFS"})(v||(v={}));const H=i=>new Promise((t,e)=>{const a=new FileReader;a.onload=()=>{const{result:o}=a;o instanceof ArrayBuffer?t(new Uint8Array(o)):t(new Uint8Array)},a.onerror=o=>{var s,f;e(Error(`File could not be read! Code=${((f=(s=o==null?void 0:o.target)==null?void 0:s.error)==null?void 0:f.code)||-1}`))},a.readAsArrayBuffer(i)}),J=async i=>{let t;if(typeof i=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(i)?t=atob(i.split(",")[1]).split("").map(e=>e.charCodeAt(0)):t=await(await fetch(i)).arrayBuffer();else if(i instanceof URL)t=await(await fetch(i)).arrayBuffer();else if(i instanceof File||i instanceof Blob)t=await H(i);else return new Uint8Array;return new Uint8Array(t)};let D=null,z=!1;async function Q(i){return z&&D||(D=new q,D.on("progress",({progress:t})=>{i&&i(t*100)}),D.on("log",({message:t})=>{console.log("[FFmpeg]",t)}),await D.load({coreURL:"https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.js",wasmURL:"https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm"}),z=!0),D}function tt(i){return new Promise(t=>{const e=document.createElement("video");e.src=i,e.onloadedmetadata=()=>{t({width:e.videoWidth,height:e.videoHeight,duration:e.duration})}})}async function et(i,t){return i.exec(t)}async function rt(i,t,e){const{tapEvents:a=[],outputAspect:o="9:16",showDeviceFrame:s=!0,videoTransform:f={scale:1,x:0,y:0,stretch:!1},appliedCrop:l={x:0,y:0,width:100,height:100},zoomLevel:N=1.4}=t,I=await Q(g=>e(20+g*.7));e(5);const E=URL.createObjectURL(i),M=await tt(E);URL.revokeObjectURL(E);const{width:b,height:y}=M,{width:A,height:R}=Y(o,b,y);e(10),await I.writeFile("input.mp4",await J(i)),e(15);const _=it({srcW:b,srcH:y,outW:A,outH:R,videoTransform:f,appliedCrop:l,showDeviceFrame:s,zoomLevel:N,tapEvents:a,duration:M.duration});e(20),await et(I,["-i","input.mp4","-vf",_,"-c:v","libx264","-preset","fast","-crf","23","-c:a","aac","-b:a","128k","-movflags","+faststart","-y","output.mp4"]),e(95);const $=await I.readFile("output.mp4");return await I.deleteFile("input.mp4"),await I.deleteFile("output.mp4"),e(100),$}function it({srcW:i,srcH:t,outW:e,outH:a,videoTransform:o,appliedCrop:s,showDeviceFrame:f,zoomLevel:l,tapEvents:N,duration:I}){const E=[];if(s.x!==0||s.y!==0||s.width!==100||s.height!==100){const A=Math.round(s.x/100*i),R=Math.round(s.y/100*t),_=Math.round(s.width/100*i),$=Math.round(s.height/100*t);E.push(`crop=${_}:${$}:${A}:${R}`)}if(N.length>0){let R="1",_="iw/2",$="ih/2";const g=[],k=[],T=[];for(const x of N){const w=Math.round(x.time*30),F=Math.round(.6*30),C=x.zoomLevel||l;g.push(`if(between(on,${w},${w+F}),${1+(C-1)*.5}*sin((on-${w})/${F}*PI),1)`);const P=x.x/i,j=x.y/t;k.push(`if(between(on,${w},${w+F}),iw*${P},iw/2)`),T.push(`if(between(on,${w},${w+F}),ih*${j},ih/2)`)}g.length>0&&(R=`max(${g.join(",")})`,_=k.length>0?k[0]:"iw/2",$=T.length>0?T[0]:"ih/2"),E.push(`zoompan=z='${R}':x='${_}-(iw/zoom/2)':y='${$}-(ih/zoom/2)':d=1:s=${i}x${t}:fps=30`)}const{scale:b,stretch:y}=o;if(y||!f)E.push(`scale=${e}:${a}:force_original_aspect_ratio=disable`);else{const A=Math.round(e*b),R=Math.round(a*b);E.push(`scale=${A}:${R}:force_original_aspect_ratio=decrease`),E.push(`pad=${e}:${a}:(${e}-iw)/2:(${a}-ih)/2:color=black`)}return E.push("pad=ceil(iw/2)*2:ceil(ih/2)*2"),E.join(",")}export{rt as renderWithFFmpeg};
